<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SaludPlus – Plataforma Integral de Salud</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: 'Inter', sans-serif; background: #f3f4f6; }
    .sidebar { width: 260px; background: white; padding: 1.5rem; position: fixed; top: 0; bottom: 0; overflow-y: auto; box-shadow: 2px 0 8px rgba(0,0,0,0.1); }
    .sidebar-left { left: 0; }
    .sidebar-right { right: 0; }
    .main { margin: 2rem 300px; }
    .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .btn { transition: background .3s; cursor: pointer; }
    .error { background: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    /******************** HELPERS ********************/
    function calcAge(dateStr){
      const d=new Date(dateStr); if(isNaN(d)) return 0;
      const now=new Date();
      let age=now.getFullYear()-d.getFullYear();
      const m=now.getMonth()-d.getMonth();
      if(m<0|| (m===0&&now.getDate()<d.getDate())) age--; // ajuste mes/día
      return age;
    }

    /******************** DATA ********************/
    const FOOD_DB={
      // Frutas
      manzana:        {energy:52, protein:0.3, carbs:14, fats:0.2},
      platano:        {energy:89, protein:1.1, carbs:23, fats:0.3},
      naranja:        {energy:47, protein:0.9, carbs:12, fats:0.1},
      pera:           {energy:57, protein:0.4, carbs:15, fats:0.1},
      kiwi:           {energy:61, protein:1.1, carbs:15, fats:0.5},
      fresa:          {energy:33, protein:0.8, carbs:8, fats:0.3},
      sandia:         {energy:30, protein:0.6, carbs:8, fats:0.2},
      melon:          {energy:34, protein:0.8, carbs:8, fats:0.2},
      mango:          {energy:60, protein:0.8, carbs:15, fats:0.4},
      uva:            {energy:69, protein:0.7, carbs:18, fats:0.2},
      cereza:         {energy:50, protein:1, carbs:12, fats:0.3},
      piña:           {energy:50, protein:0.5, carbs:13, fats:0.1},

      // Verduras y hortalizas
      tomate:         {energy:18, protein:0.9, carbs:3.9, fats:0.2},
      zanahoria:      {energy:41, protein:0.9, carbs:10, fats:0.2},
      lechuga:        {energy:15, protein:1.4, carbs:2.9, fats:0.2},
      brocoli:        {energy:34, protein:2.8, carbs:7, fats:0.4},
      espinaca:       {energy:23, protein:2.9, carbs:3.6, fats:0.4},
      calabacin:      {energy:17, protein:1.2, carbs:3.1, fats:0.3},
      cebolla:        {energy:40, protein:1.1, carbs:9, fats:0.1},
      patata:         {energy:77, protein:2, carbs:17, fats:0.1},
      batata:         {energy:86, protein:1.6, carbs:20, fats:0.1},
      berenjena:      {energy:25, protein:1, carbs:6, fats:0.2},
      champiñon:      {energy:22, protein:3.1, carbs:3.3, fats:0.3},
      coliflor:       {energy:25, protein:2, carbs:5, fats:0.3},

      // Legumbres y cereales
      lentejas:       {energy:116, protein:9, carbs:20, fats:0.4},
      garbanzos:      {energy:164, protein:9, carbs:27, fats:2.6},
      alubias:        {energy:127, protein:9, carbs:22, fats:0.5},
      arroz:          {energy:130, protein:2.7, carbs:28, fats:0.3},
      arroz_integral: {energy:123, protein:2.7, carbs:25, fats:1},
      avena:          {energy:389, protein:16.9, carbs:66, fats:6.9},
      quinoa:         {energy:120, protein:4.1, carbs:21, fats:1.9},
      maiz:           {energy:86, protein:3.2, carbs:19, fats:1.2},

      // Panes y harinas
      pan:            {energy:265, protein:9, carbs:49, fats:3.2},
      pan_integral:   {energy:247, protein:8.8, carbs:41, fats:3.3},
      pasta:          {energy:131, protein:5, carbs:25, fats:1.1},
      pasta_integral: {energy:124, protein:5.5, carbs:27, fats:0.9},

      // Carnes y pescados
      pollo:          {energy:165, protein:31, carbs:0, fats:3.6},
      ternera:        {energy:250, protein:26, carbs:0, fats:17},
      cerdo:          {energy:242, protein:27, carbs:0, fats:14},
      pavo:           {energy:104, protein:22, carbs:0, fats:2},
      cordero:        {energy:294, protein:25, carbs:0, fats:21},
      atun:           {energy:132, protein:28, carbs:0, fats:1},
      salmon:         {energy:208, protein:20, carbs:0, fats:13},
      merluza:        {energy:70, protein:12, carbs:0, fats:2},
      sardina:        {energy:208, protein:25, carbs:0, fats:11},
      huevo:          {energy:155, protein:13, carbs:1.1, fats:11},
      clara_huevo:    {energy:52, protein:11, carbs:0.7, fats:0.2},

      // Lácteos y alternativas
      leche:          {energy:42, protein:3.4, carbs:5, fats:1},
      leche_soja:     {energy:33, protein:3.3, carbs:0.6, fats:1.6},
      yogur:          {energy:59, protein:10, carbs:3.6, fats:0.4},
      queso:          {energy:402, protein:25, carbs:1.3, fats:33},
      queso_cottage:  {energy:98, protein:11, carbs:3.4, fats:4.3},

      // Frutos secos y semillas
      nueces:         {energy:654, protein:15, carbs:14, fats:65},
      almendras:      {energy:579, protein:21, carbs:22, fats:50},
      avellanas:      {energy:628, protein:15, carbs:17, fats:61},
      cacahuetes:     {energy:567, protein:26, carbs:16, fats:49},
      pistachos:      {energy:562, protein:20, carbs:28, fats:45},
      chia:           {energy:486, protein:17, carbs:42, fats:31},
      lino:           {energy:534, protein:18, carbs:29, fats:42},
      semillas_girasol:{energy:584, protein:21, carbs:20, fats:52},

      // Aceites y grasas
      aceite_oliva:   {energy:884, protein:0, carbs:0, fats:100},
      aceite_girasol: {energy:884, protein:0, carbs:0, fats:100},
      mantequilla:    {energy:717, protein:0.9, carbs:0.1, fats:81},

      // Platos preparados y snacks
      tortilla_patata:{energy:154, protein:7, carbs:10, fats:9},
      pizza:          {energy:266, protein:11, carbs:33, fats:10},
      paella:         {energy:174, protein:7, carbs:22, fats:6},
      gazpacho:       {energy:44, protein:1, carbs:6, fats:2},
      lasaña:         {energy:135, protein:7, carbs:13, fats:6},
      empanada:       {energy:290, protein:6, carbs:27, fats:17},
      croquetas:      {energy:196, protein:7, carbs:17, fats:11},

      // Otros básicos
      azucar:         {energy:387, protein:0, carbs:100, fats:0},
      miel:           {energy:304, protein:0.3, carbs:82, fats:0},
      mermelada:      {energy:278, protein:0.4, carbs:70, fats:0.1}
      // Puedes seguir ampliando la lista aquí
    };

    const ACT_FACT={sedentario:1.2, ligero:1.375, moderado:1.55, activo:1.725, muy_activo:1.9};
    const MACRO_LABEL={calories:'Calorías',protein:'Proteínas',carbs:'Carbohidratos',fats:'Grasas'};

    /******************** ERROR BOUNDARY ********************/
    class ErrorBoundary extends React.Component{
      constructor(p){super(p);this.state={err:null}}
      static getDerivedStateFromError(err){return{err}}
      componentDidCatch(e,i){console.error(e,i)}
      render(){return this.state.err?<div className="error">{this.state.err.message}</div>:this.props.children}
    }

    /******************** LANDING ********************/
    const Landing=({onStart})=>(
      <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-indigo-600 to-purple-600 text-white p-8">
        <h1 className="text-6xl font-extrabold mb-4 drop-shadow">SaludPlus</h1>
        <p className="text-xl max-w-2xl text-center mb-8">Plataforma integral para controlar tu nutrición, entrenamiento y salud.</p>
        <button onClick={onStart} className="btn bg-white text-indigo-700 font-semibold px-8 py-4 rounded-full shadow hover:bg-indigo-50">Comenzar registro</button>
      </div>
    );

    /******************** REGISTRATION ********************/
    function Registration({onSave,onBack}){
      const [form,setForm]=useState({name:'',dob:'',weight:'',height:'',activity:'sedentario',goal:'mantenimiento'});
      const handle=(k,v)=>setForm({...form,[k]:v});
      const save=()=>{
        for(const fKey of ['name','dob','weight','height']){ if(!form[fKey]){alert('Completa '+fKey);return;} }
        const weight=parseFloat(form.weight), height=parseFloat(form.height); const age=calcAge(form.dob);
        const bmr=10*weight+6.25*height-5*age+5; const calories=Math.round(bmr*ACT_FACT[form.activity]);
        const goal={calories, protein:Math.round(calories*0.2/4), carbs:Math.round(calories*0.5/4), fats:Math.round(calories*0.3/9)};
        const user={...form,age};
        localStorage.setItem('user',JSON.stringify(user));
        localStorage.setItem('goal',JSON.stringify(goal));
        localStorage.setItem('entries','[]');
        localStorage.setItem('history',JSON.stringify([{date:new Date().toISOString().slice(0,10),weight}]));
        onSave(user,goal);
      };
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
          <div className="card w-full max-w-lg space-y-6">
            <h2 className="text-3xl font-semibold text-center">Registro</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <input className="border p-3 rounded" placeholder="Nombre" value={form.name} onChange={e=>handle('name',e.target.value)} />
              <input type="date" className="border p-3 rounded" value={form.dob} onChange={e=>handle('dob',e.target.value)} />
              <input type="number" className="border p-3 rounded" placeholder="Peso (kg)" value={form.weight} onChange={e=>handle('weight',e.target.value)} />
              <input type="number" className="border p-3 rounded" placeholder="Altura (cm)" value={form.height} onChange={e=>handle('height',e.target.value)} />
              <select className="border p-3 rounded" value={form.activity} onChange={e=>handle('activity',e.target.value)}>
                {Object.keys(ACT_FACT).map(k=><option key={k} value={k}>{k.replace('_',' ')}</option>)}
              </select>
              <select className="border p-3 rounded" value={form.goal} onChange={e=>handle('goal',e.target.value)}>
                <option value="mantenimiento">Mantenimiento</option>
                <option value="perder_peso">Perder peso</option>
                <option value="ganar_masa">Ganar masa</option>
              </select>
            </div>
            <div className="flex justify-between">
              <button onClick={onBack} className="btn px-6 py-3 border rounded hover:bg-gray-200">Volver</button>
              <button onClick={save} className="btn px-6 py-3 bg-indigo-600 text-white rounded hover:bg-indigo-700">Guardar</button>
            </div>
          </div>
        </div>
      );
    }

    /******************** SIDEBARS ********************/
    const SidebarPerfil=({user})=>!user?null:(
      <div className="sidebar sidebar-left">
        <div className="text-center mb-6">
          <div className="w-24 h-24 bg-indigo-100 rounded-full mx-auto flex items-center justify-center text-indigo-500 text-3xl">{user.name[0]}</div>
          <h3 className="mt-2 text-xl font-semibold">{user.name}</h3>
          <p className="text-sm text-gray-600">Edad: {user.age} años</p>
        </div>
        <div className="space-y-1">
          <p><strong>Peso:</strong> {user.weight} kg</p>
          <p><strong>Altura:</strong> {user.height} cm</p>
          <p><strong>Actividad:</strong> {user.activity ? user.activity.replace('_',' ') : '—'}</p>
          <p><strong>Objetivo:</strong> {user.goal ? user.goal.replace('_',' ') : '—'}</p>
        </div>
      </div>
    );

    function SidebarHistory({history}){
      const ref=useRef();
      useEffect(()=>{
        if(ref.current._chart) ref.current._chart.destroy();
        ref.current._chart=new Chart(ref.current.getContext('2d'),{
          type:'line',
          data:{labels:history.map(h=>h.date),datasets:[{label:'Peso',data:history.map(h=>h.weight),borderColor:'#3b82f6',fill:false}]},
          options:{responsive:true,plugins:{legend:{display:false}}}
        });
      },[history]);
      return (
        <div className="sidebar sidebar-right">
          <h3 className="font-semibold mb-4">Histórico de Peso</h3>
          <canvas ref={ref}></canvas>
        </div>
      );
    }

    /******************** DASHBOARD ********************/
    function Dashboard({user,goal}){
      const [entries,setEntries]=useState(JSON.parse(localStorage.getItem('entries')||'[]'));
      const [food,setFood]=useState(''); const [qty,setQty]=useState(1);
      const [newW,setNewW]=useState(user.weight);
      const pieRef=useRef(); const today=new Date().toISOString().slice(0,10);
      const todays=entries.filter(e=>e.date===today);
      useEffect(()=>
