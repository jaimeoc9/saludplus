<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SaludPlus – Plataforma Integral de Salud</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: 'Inter', sans-serif; background: #f3f4f6; }
    .sidebar { width: 260px; background: white; padding: 1.5rem; position: fixed; top: 0; bottom: 0; overflow-y: auto; box-shadow: 2px 0 8px rgba(0,0,0,0.1); }
    .sidebar-left { left: 0; }
    .sidebar-right { right: 0; }
    .main { margin: 2rem 300px; }
    .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .btn { transition: background .3s; cursor: pointer; }
    .error { background: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    /******************** HELPERS ********************/
    function calcAge(dateStr){
      const d=new Date(dateStr); if(isNaN(d)) return 0;
      const now=new Date();
      let age=now.getFullYear()-d.getFullYear();
      const m=now.getMonth()-d.getMonth();
      if(m<0|| (m===0&&now.getDate()<d.getDate())) age--; // ajuste mes/día
      return age;
    }

    /******************** DATA ********************/
    const FOOD_DB={
  manzana:{energy:52,protein:0.3,carbs:14,fats:0.2},
  platano:{energy:89,protein:1.1,carbs:23,fats:0.3},
  pan:{energy:265,protein:9,carbs:49,fats:3.2},
  pollo:{energy:165,protein:31,carbs:0,fats:3.6},
  arroz:{energy:130,protein:2.7,carbs:28,fats:0.3},
  huevo:{energy:155,protein:13,carbs:1.1,fats:11},
  avena:{energy:389,protein:17,carbs:66,fats:7},
  leche:{energy:42,protein:3.4,carbs:5,fats:1}, 
  tomate:{energy:18,protein:0.9,carbs:3.9,fats:0.2},
  atun:{energy:132,protein:28,carbs:0,fats:1.3},
  lentejas:{energy:116,protein:9,carbs:20,fats:0.4},
  espinacas:{energy:23,protein:2.9,carbs:3.6,fats:0.4},
  salmón:{energy:208,protein:20,carbs:0,fats:13},
  yogur:{energy:59,protein:10,carbs:3.6,fats:0.4},
  galletas:{energy:502,protein:6,carbs:72,fats:24},
  pizza:{energy:266,protein:11,carbs:33,fats:10},
  pasta:{energy:131,protein:5,carbs:25,fats:1.1},
  carne_vacuno:{energy:250,protein:26,carbs:0,fats:17},
  brocoli:{energy:34,protein:2.8,carbs:6.6,fats:0.4},
  zanahoria:{energy:41,protein:0.9,carbs:10,fats:0.2}
};
    };
    const ACT_FACT={sedentario:1.2, ligero:1.375, moderado:1.55, activo:1.725, muy_activo:1.9};
    const MACRO_LABEL={calories:'Calorías',protein:'Proteínas',carbs:'Carbohidratos',fats:'Grasas'};

    /******************** ERROR BOUNDARY ********************/
    class ErrorBoundary extends React.Component{
      constructor(p){super(p);this.state={err:null}}
      static getDerivedStateFromError(err){return{err}}
      componentDidCatch(e,i){console.error(e,i)}
      render(){return this.state.err?<div className="error">{this.state.err.message}</div>:this.props.children}
    }

    /******************** LANDING ********************/
    const Landing=({onStart})=>(
      <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-indigo-600 to-purple-600 text-white p-8">
        <h1 className="text-6xl font-extrabold mb-4 drop-shadow">SaludPlus</h1>
        <p className="text-xl max-w-2xl text-center mb-8">Plataforma integral para controlar tu nutrición, entrenamiento y salud.</p>
        <button onClick={onStart} className="btn bg-white text-indigo-700 font-semibold px-8 py-4 rounded-full shadow hover:bg-indigo-50">Comenzar registro</button>
      </div>
    );

    /******************** REGISTRATION ********************/
    function Registration({onSave,onBack}){
      const [form,setForm]=useState({name:'',dob:'',weight:'',height:'',activity:'sedentario',goal:'mantenimiento'});
      const handle=(k,v)=>setForm({...form,[k]:v});
      const save=()=>{
        for(const fKey of ['name','dob','weight','height']){ if(!form[fKey]){alert('Completa '+fKey);return;} }
        const weight=parseFloat(form.weight), height=parseFloat(form.height); const age=calcAge(form.dob);
        const bmr=10*weight+6.25*height-5*age+5; const calories=Math.round(bmr*ACT_FACT[form.activity]);
        const goal={calories, protein:Math.round(calories*0.2/4), carbs:Math.round(calories*0.5/4), fats:Math.round(calories*0.3/9)};
        const user={...form,age};
        localStorage.setItem('user',JSON.stringify(user));
        localStorage.setItem('goal',JSON.stringify(goal));
        localStorage.setItem('entries','[]');
        localStorage.setItem('history',JSON.stringify([{date:new Date().toISOString().slice(0,10),weight}]));
        onSave(user,goal);
      };
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
          <div className="card w-full max-w-lg space-y-6">
            <h2 className="text-3xl font-semibold text-center">Registro</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <input className="border p-3 rounded" placeholder="Nombre" value={form.name} onChange={e=>handle('name',e.target.value)} />
              <input type="date" className="border p-3 rounded" value={form.dob} onChange={e=>handle('dob',e.target.value)} />
              <input type="number" className="border p-3 rounded" placeholder="Peso (kg)" value={form.weight} onChange={e=>handle('weight',e.target.value)} />
              <input type="number" className="border p-3 rounded" placeholder="Altura (cm)" value={form.height} onChange={e=>handle('height',e.target.value)} />
              <select className="border p-3 rounded" value={form.activity} onChange={e=>handle('activity',e.target.value)}>
                {Object.keys(ACT_FACT).map(k=><option key={k} value={k}>{k.replace('_',' ')}</option>)}
              </select>
              <select className="border p-3 rounded" value={form.goal} onChange={e=>handle('goal',e.target.value)}>
                <option value="mantenimiento">Mantenimiento</option>
                <option value="perder_peso">Perder peso</option>
                <option value="ganar_masa">Ganar masa</option>
              </select>
            </div>
            <div className="flex justify-between">
              <button onClick={onBack} className="btn px-6 py-3 border rounded hover:bg-gray-200">Volver</button>
              <button onClick={save} className="btn px-6 py-3 bg-indigo-600 text-white rounded hover:bg-indigo-700">Guardar</button>
            </div>
          </div>
        </div>
      );
    }

    /******************** SIDEBARS ********************/
    const SidebarPerfil=({user})=>!user?null:(
      <div className="sidebar sidebar-left">
        <div className="text-center mb-6">
          <div className="w-24 h-24 bg-indigo-100 rounded-full mx-auto flex items-center justify-center text-indigo-500 text-3xl">{user.name[0]}</div>
          <h3 className="mt-2 text-xl font-semibold">{user.name}</h3>
          <p className="text-sm text-gray-600">Edad: {user.age} años</p>
        </div>
        <div className="space-y-1">
          <p><strong>Peso:</strong> {user.weight} kg</p>
          <p><strong>Altura:</strong> {user.height} cm</p>
          <p><strong>Actividad:</strong> {user.activity ? user.activity.replace('_',' ') : '—'}</p>
          <p><strong>Objetivo:</strong> {user.goal ? user.goal.replace('_',' ') : '—'}</p>
        </div>
      </div>
    );

    function SidebarHistory({history}){
      const ref=useRef();
      useEffect(()=>{
        if(ref.current._chart) ref.current._chart.destroy();
        ref.current._chart=new Chart(ref.current.getContext('2d'),{
          type:'line',
          data:{labels:history.map(h=>h.date),datasets:[{label:'Peso',data:history.map(h=>h.weight),borderColor:'#3b82f6',fill:false}]},
          options:{responsive:true,plugins:{legend:{display:false}}}
        });
      },[history]);
      return (
        <div className="sidebar sidebar-right">
          <h3 className="font-semibold mb-4">Histórico de Peso</h3>
          <canvas ref={ref}></canvas>
        </div>
      );
    }

    /******************** DASHBOARD ********************/
    function Dashboard({user,goal}){
      const [entries,setEntries]=useState(JSON.parse(localStorage.getItem('entries')||'[]'));
      const [food,setFood]=useState(''); const [qty,setQty]=useState(1);
      const [newW,setNewW]=useState(user.weight);
      const pieRef=useRef(); const today=new Date().toISOString().slice(0,10);
      const addWeight=()=>{
  const hist = JSON.parse(localStorage.getItem('history') || '[]');
  hist.push({date: today, weight: +newW});
  localStorage.setItem('history', JSON.stringify(hist));
  alert('Peso añadido');
  window.location.reload(); // <-- esto asegura que se actualice la gráfica
};
      const todays=entries.filter(e=>e.date===today);
      useEffect(()=>{ if(pieRef.current._chart) pieRef.current._chart.destroy();
        const t={protein:0,carbs:0,fats:0}; todays.forEach(e=>{t.protein+=e.protein;t.carbs+=e.carbs;t.fats+=e.fats});
        pieRef.current._chart=new Chart(pieRef.current.getContext('2d'),{type:'pie',data:{labels:['Proteínas','Carbs','Grasas'],datasets:[{data:[t.protein,t.carbs,t.fats],backgroundColor:['#10B981','#3b82f6','#FBBF24']}]}});
      },[entries]);
      const addFood=()=>{const base=FOOD_DB[food.trim().toLowerCase()]; if(!base){alert('No está en la BD');return;} const e={id:Date.now(),date:today,name:food,protein:base.protein*qty,carbs:base.carbs*qty,fats:base.fats*qty,calories:base.energy*qty}; const up=[...entries,e]; setEntries(up); localStorage.setItem('entries',JSON.stringify(up));};
      const addWeight=()=>{const hist=JSON.parse(localStorage.getItem('history')||'[]'); hist.push({date:today,weight:+newW}); localStorage.setItem('history',JSON.stringify(hist)); alert('Peso añadido');};
      return (
        <div className="main space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-semibold">¡Hola, {user.name}!</h2>
            <button onClick={()=>{ localStorage.clear(); window.location.reload(); }} className="bg-red-500 text-white px-4 py-2 rounded">Cerrar sesión</button>
          </div>
          <div className="card mb-4 flex items-end gap-2"><input type="number" className="border p-2 rounded w-24" value={newW} onChange={e=>setNewW(e.target.value)} /><button onClick={addWeight} className="bg-green-600 text-white px-4 py-2 rounded">Añadir Peso</button></div>
          <div className="card grid grid-cols-4 gap-4">
            {Object.entries(goal).map(([k,v])=>(
              <div key={k}><label className="text-sm">{MACRO_LABEL[k]}</label><input disabled className="w-full border p-1 rounded" value={v}/></div>
            ))}
          </div>
          <div className="card flex gap-2">
            <input className="flex-1 border p-2 rounded" placeholder="Alimento" value={food} onChange={e=>setFood(e.target.value)} />
            <input type="number" className="w-20 border p-2 rounded" value={qty} onChange={e=>setQty(+e.target.value)} />
            <button onClick={addFood} className="bg-blue-600 text-white px-4 rounded">Añadir</button>
          </div>
          <div className="card">
            <h3 className="font-semibold mb-1">Comidas de hoy</h3>
            {todays.length?todays.map(e=>(<p key={e.id}>{e.name} – {Math.round(e.calories)} Kcal</p>)):<p className="text-gray-500">Sin registros.</p>}
          </div>
          <div className="card">
            <h3 className="font-semibold mb-1">Distribución de macros</h3>
            <canvas ref={pieRef}></canvas>
          </div>
        </div>
      );
    }

    /******************** ROOT APP ********************/
    function App(){
      const [step,setStep]=useState('landing');
      const [user,setUser]=useState(null); const [goal,setGoal]=useState(null);
      useEffect(()=>{const u=JSON.parse(localStorage.getItem('user')||'null');const g=JSON.parse(localStorage.getItem('goal')||'null');if(u&&g){setUser(u);setGoal(g);setStep('dash');}},[]);
      const onSave=(u,g)=>{setUser(u);setGoal(g);setStep('dash');};
      return (
        <ErrorBoundary>
          {step==='landing'&&<Landing onStart={()=>setStep('reg')} />}
          {step==='reg'&&<Registration onSave={onSave} onBack={()=>setStep('landing')} />}
          {step==='dash'&&<>
            <SidebarPerfil user={user} />
            <SidebarHistory history={JSON.parse(localStorage.getItem('history')||'[]')} />
            <Dashboard user={user} goal={goal} />
          </>}
        </ErrorBoundary>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
